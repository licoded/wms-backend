<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <link rel="Bookmark" href="/favicon.ico" >
    <link rel="Shortcut Icon" href="/favicon.ico" />
    <!--[if lt IE 9]>
    <script type="text/javascript" src="js/uiadmin/lib/html5shiv.js"></script>
    <script type="text/javascript" src="js/uiadmin/lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="js/uiadmin/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="js/uiadmin/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css" href="js/uiadmin/lib/Hui-iconfont/1.0.8/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="js/uiadmin/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css" href="js/uiadmin/h-ui.admin/css/style.css" />
    <!--提示框-->
    <link rel="stylesheet" type="text/css" href="js/uiadmin/pop_up/dialog/dialog.css" />
    <script type="text/javascript" src="js/uiadmin/pop_up/dialog/zepto.min.js"></script>
    <script type="text/javascript" src="js/uiadmin/pop_up/dialog/dialog.min.js"></script>
    <!--[if IE 6]>
    <script type="text/javascript" src="js/uiadmin/lib/DD_belatedPNG_0.0.8a-min.js" ></script>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <title>业务结转</title>
    <meta name="keywords" content="H-ui.admin v3.1,H-ui网站后台模版,后台模版下载,后台管理系统模版,HTML后台模版下载">
    <meta name="description" content="H-ui.admin v3.1，是一款由国人开发的轻量级扁平化网站后台模板，完全免费开源的网站后台管理系统模版，适合中小型CMS后台系统。">
</head>
<body>

<article class="page-container">
<!--    <div class="text-c"> 日期范围：-->
<!--&lt;!&ndash;        <input type="text" onfocus="WdatePicker({ maxDate:'#F{$dp.$D(\'start\')||\'%y-%M-%d\'}' })" id="start" class="input-text Wdate" style="width:120px;">&ndash;&gt;-->

<!--        <input type="text" onfocus="WdatePicker({ minDate:'#F{$dp.$D(\'end\')}',maxDate:'%y-%M-%d' })" id="end" class="input-text Wdate" autocomplete="off" style="width:120px; z-index: 100">-->
<!--&lt;!&ndash;        <input type="text" class="input-text" style="width:250px" placeholder="仓库" id="repository" >&ndash;&gt;-->
<!--&lt;!&ndash;        <button type="submit" class="btn btn-success" onclick="list()"><i class="Hui-iconfont">&#xe665;</i> 选择仓库</button>&ndash;&gt;-->
<!--    </div>-->
    <form class="form form-horizontal" id="form-admin-add">
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>调拨发起仓库：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="hidden" id="cache_id_0">
                <input type="text" class="input-text" autocomplete="off" value="" placeholder=" "
                       id="dis_name0" name="dis_name0" readonly="readonly">
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>调拨目的仓库：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text"  id="dis_name1" name="dis_name1" >
            </div>
        </div>
                <div class="row cl">
                    <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>调拨物资：</label>
                    <div class="formControls col-xs-8 col-sm-9">
                        <input type="hidden" id="material_id">
                        <input type="text" class="input-text" id="material_name" name="material_name" readonly="readonly">
                    </div>
                </div>
                <div class="row cl">
                    <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>当前该物资库存量：</label>
                    <div class="formControls col-xs-8 col-sm-9">
                        <input type="text" class="input-text" id="cache_numbers" name="cache_numbers" readonly="readonly">
                    </div>
                </div>
        <!--        <div class="row cl">-->
        <!--            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>初始密码：</label>-->
        <!--            <div class="formControls col-xs-8 col-sm-9">-->
        <!--                <input type="text" class="input-text" autocomplete="off" value="" placeholder="密码"-->
        <!--                       id="password" name="password">-->
        <!--            </div>-->
        <!--        </div>-->
        <!--        <div class="row cl">-->
        <!--            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>负责的仓库：</label>-->
        <!--            <div class="formControls col-xs-8 col-sm-9">-->
        <!--                <input type="text" class="input-text" autocomplete="off" value="" placeholder="负责的仓库,调拨员为0"-->
        <!--                       id="cache" name="cache">-->
        <!--            </div>-->
        <!--        </div>-->
        <div class="row cl">
            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>调拨数量：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" autocomplete="off" value="" placeholder=" "
                       id="change_numbers" name="change_numbers">
            </div>
        </div>

<!--        <div class="row cl">-->
<!--            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>调拨时间：</label>-->
<!--            <div class="formControls col-xs-8 col-sm-9">-->
<!--                <input type="text" class="input-text Wdate" onfocus="WdatePicker({ minDate:'#F{$dp.$D(\'end\')}',maxDate:'%y-%M-%d' })" id="end"  name="end"  autocomplete="off" class="input-text Wdate" style="width:120px;" >-->
<!--&lt;!&ndash;                <input type="text" class="input-text" autocomplete="off" value="" placeholder=" "&ndash;&gt;-->
<!--&lt;!&ndash;                       id="cache_time" name="cache_time">&ndash;&gt;-->
<!--&lt;!&ndash;                <input type="text" onfocus="WdatePicker({ minDate:'#F{$dp.$D(\'end\')}',maxDate:'%y-%M-%d' })" id="end" class="input-text Wdate" style="width:120px;">&ndash;&gt;-->
<!--            </div>-->
<!--        </div>-->


<!--        </div>-->
<!--        <div class="row-c">-->
<!--            <label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>调拨时间：</label>-->
<!--            <div class="formControls col-xs-8 col-sm-9">-->
<!--               <input type="text" onfocus="WdatePicker({ minDate:'#F{$dp.$D(\'end\')}',maxDate:'%y-%M-%d' })" id="end" class="input-text Wdate" style="width:120px;">-->
<!--            </div>-->
<!--        </div>-->
        <div class="row cl">
            <div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
                <input class="btn btn-primary radius" type="button" onclick="modify()" value="&nbsp;&nbsp;提交&nbsp;&nbsp;">
            </div>
        </div>
    </form>
</article>

<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="js/uiadmin/lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="js/uiadmin/lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="js/uiadmin/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="js/uiadmin/h-ui.admin/js/H-ui.admin.js"></script> <!--/_footer 作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="js/uiadmin/lib/My97DatePicker/4.8/WdatePicker.js"></script>
<script type="text/javascript" src="js/uiadmin/lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="js/uiadmin/lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="js/uiadmin/lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript" src="js/uiadmin/lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="js/uiadmin/lib/laypage/1.2/laypage.js"></script>

<script>

    // $(function () {
    //     $.ajax({
    //         url: "/cache/review",
    //         type: "post",
    //         dataType : 'json',
    //         data: {},
    //         error:function (data) {},
    //         success:function (data) {
    //             $("#dis_name0").val(data.cache_id);
    //             $("#material_name").val(data.material.material_name);
    //             $("#cache_numbers").val(data.cache_numbers);
    //         }
    //     })
    // });
    $(function(){

        review();
    });

    function review() {

        $.ajax({
            type: 'POST',
            url: '/cache/review',
            dataType: 'json',
            data:{

            },
            success: function(data){
                if(data.state == 1){
                    $("#cache_id_0").val(data.cache.cache_id);
                    $("#dis_name0").val(data.cache.repository.repository_id);
                    $("#material_id").val(data.cache.material.material_id);
                    $("#material_name").val(data.cache.material.material_name);
                    $("#cache_numbers").val(data.cache.cache_numbers);
                }
            },
            error:function(data) {
                console.log(data.msg);
            },
            cache:false
        });

    }

    //检查调拨额度的合理性
    function check() {
        if(($("#change_numbers").val()!=null && $("#change_numbers").val()>0) && $("#cache_numbers").val()>= $("#change_numbers").val()){
            return  true;
        }
        else{
            return false;
        }
    }
    function modify() {
        if(check()==false){
            popup({type:'error',msg:"调拨数量不合理",delay:1000,bg:true,clickDomCancel:true});
            return false;
        }
        cache_add();
    }

    function dispatch_add() {
        $.ajax({
            type: 'POST',
            url: '/dispatch/add',
            datatype: 'json',
            cache: false,
            data:{
                "repository_id_0": $("#dis_name0").val(),
                "repository_id_1": $("#dis_name1").val(),
                "cache_id": $("#cache_id_0").val(),
                "dispatch_num": $("#change_numbers").val()


            },
            // success:function(data){
            //     popup({type:'success',msg:"成功",delay:1000,callBack:function(){
            //             //location.assign("/");
            //             var index = parent.layer.getFrameIndex(window.name);
            //             parent.layer.close(index);
            //         }});
            // },
            error:function(data) {
                popup({type:'error',msg:"失败",delay:1000,bg:true,clickDomCancel:true});
                console.log(data.msg);
            }
        })
    }
    function cache_add() {
        $.ajax({
            type: 'POST',
            url: '/cache/add',
            dataType: 'json',
            cache:false,
            data:{
                "material_id":$("#material_id").val(),
                "repository_id":$("#dis_name1").val(),
                // "cache_timeStr":$("#end").val(),
                "cache_numbers":Number($("#change_numbers").val())

            },
            success: function(data){
                if(data.state == 1){
                    cache_del();
                    dispatch_add();
                    popup({type:'success',msg:"成功",delay:1000,callBack:function(){
                            //location.assign("/");
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        }});
                }else{
                    popup({type:'error',msg:"爆仓警告",delay:1000,bg:true,clickDomCancel:true});
                    return false;
                }
            },
            error:function(data) {
                console.log(data.msg);
            },
            cache:false
        });
    }

    function cache_del() {

        $.ajax({
            type: 'POST',
            url: '/cache/updateNumbers',
            dataType: 'json',
            cache:false,
            data:{
                "cache_id":$("#cache_id_0").val(),
                "material_id":$("#material_id").val(),
                "repository_id":$("#dis_name0").val(),
                "cache_numbers":(Number($("#cache_numbers").val())-Number($("#change_numbers").val()))
            },
            success: function(data){
                if(data.state == 1){
                    // cache_add();

                    // popup({type:'success',msg:"成功",delay:1000,callBack:function(){
                    //         var index = parent.layer.getFrameIndex(window.name);
                    //         parent.layer.close(index);
                    //     }});
                }else{
                    popup({type:'error',msg:"失败",delay:1000,bg:true,clickDomCancel:true});
                    return false;
                }
            },
            error:function(data) {
                console.log(data.msg);
            },
            cache:false
        });

    }
</script>

<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>